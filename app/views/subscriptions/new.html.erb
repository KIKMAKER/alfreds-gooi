<div class="user-wrapper">
  <div class="collection-body">
    <h1 class="mt-4 mb-4">Pick a subscription option:</h1>
    <% if current_user.admin? %>
      <%= simple_form_for(@subscription) do |f| %>
        <%= f.input :customer_id %>
        <%= f.input :street_address, class: 'form-styling' %>
        <%= f.input :suburb %>
        <%= f.input :collection_day, as: :select, collection: Subscription.collection_days.keys.to_a %>
        <%= f.input :start_date, as: :date, html5: true %>
        <%= f.input :access_code %>
        <%= f.input :plan, label: "Choose a plan", collection: Subscription.humanized_plans.keys, include_blank: false, label_method: lambda { |key| Subscription.humanized_plans[key] } %>
        <%= f.input :duration, collection: %w[1 3 6] %>
        <%= f.button :submit, class:'gooi-button' %>
      <% end %>
    <% elsif current_user.subscriptions.where(plan: :Commercial).any? %>
      <p>Renew your commercial collection service</p>

      <% last_commercial = current_user.subscriptions.where(plan: :Commercial).order(created_at: :desc).first %>

      <div class="mb-4 mt-4" data-controller="commercial-pricing commercial-renewal" data-commercial-pricing-renewal-value="true">
        <div class="row">
          <div class="col-md-4">
            <label class="form-label"><strong>Contract Duration</strong></label>
            <div class="mb-3">
              <div class="form-check">
                <%= radio_button_tag 'commercial_duration', '12', true, class: 'form-check-input', data: { action: 'change->commercial-pricing#calculate change->commercial-renewal#updateForm' }, id: 'commercial_duration_12' %>
                <%= label_tag 'commercial_duration_12', '12 months (R200/month)', class: 'form-check-label' %>
              </div>
              <div class="form-check">
                <%= radio_button_tag 'commercial_duration', '6', false, class: 'form-check-input', data: { action: 'change->commercial-pricing#calculate change->commercial-renewal#updateForm' }, id: 'commercial_duration_6' %>
                <%= label_tag 'commercial_duration_6', '6 months (R220/month)', class: 'form-check-label' %>
              </div>
              <div class="form-check">
                <%= radio_button_tag 'commercial_duration', '3', false, class: 'form-check-input', data: { action: 'change->commercial-pricing#calculate change->commercial-renewal#updateForm' }, id: 'commercial_duration_3' %>
                <%= label_tag 'commercial_duration_3', '3 months (R240/month)', class: 'form-check-label' %>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label"><strong>Bucket Size</strong></label>
            <div class="mb-3">
              <div class="form-check">
                <%= radio_button_tag 'commercial_bucket_size', '45', (last_commercial.bucket_size || 45) == 45, class: 'form-check-input', data: { action: 'change->commercial-pricing#calculate change->commercial-renewal#updateForm' }, id: 'commercial_bucket_size_45' %>
                <%= label_tag 'commercial_bucket_size_45', '45 Litre buckets', class: 'form-check-label' %>
              </div>
              <div class="form-check">
                <%= radio_button_tag 'commercial_bucket_size', '25', (last_commercial.bucket_size || 45) == 25, class: 'form-check-input', data: { action: 'change->commercial-pricing#calculate change->commercial-renewal#updateForm' }, id: 'commercial_bucket_size_25' %>
                <%= label_tag 'commercial_bucket_size_25', '25 Litre buckets', class: 'form-check-label' %>
              </div>
            </div>
            <small class="text-muted">Current: <%= last_commercial.bucket_size || 45 %>L</small>
          </div>

          <div class="col-md-4">
            <label class="form-label"><strong>Buckets per collection</strong></label>
            <%= number_field_tag 'commercial_buckets', last_commercial.buckets_per_collection || 1,
                      min: 1, max: 20,
                      class: 'form-control mb-3',
                      data: { action: 'input->commercial-pricing#calculate input->commercial-renewal#updateForm', commercial_pricing_target: 'buckets', commercial_renewal_target: 'buckets' },
                      id: 'commercial_buckets_field' %>
            <small class="text-muted">Current: <%= last_commercial.buckets_per_collection %> buckets</small>
          </div>
        </div>

        <div class="mt-3 p-3 bg-light rounded" data-commercial-pricing-target="estimate">
          <p class="mb-1"><strong>Estimated cost:</strong></p>
          <p class="mb-0" data-commercial-pricing-target="price">Calculating...</p>
        </div>

        <%= form_with url: subscriptions_path, method: :post,
                      data: { turbo: false, commercial_renewal_target: 'form' },
                      html: { id: 'commercial-renewal-form' } do |f| %>
          <%= f.hidden_field :og, value: false %>
          <%= f.hidden_field :new, value: false %>
          <%= f.hidden_field 'subscription[plan]', value: 'Commercial' %>
          <%= f.submit 'Renew Subscription', class: 'sign-up-btn mt-3' %>
        <% end %>
      </div>
  <% else %>
    <section>
      <div class="subscription-rates-update">
        <% unless current_user.og %>
          <div class="mb-4 p-3 text-center" style="background-color: #f8f9fa; border-radius: 8px; margin: 0 auto">
            <label for="discount-code-input" class="form-label">Have a discount code?</label>
            <input type="text" id="discount-code-input" class="form-control" placeholder="Enter code" style="max-width: 300px;">
            <small class="text-muted">Optional - leave blank if you don't have one</small>
          </div>
        <% end %>
        <h2>Standard Subscriptions</h2>
        <p>Pick a duration for a weekly pick up of 1-2 bags of compostable waste</p>
        <% if current_user.og %>
          <p>As an Original Gooier you get our special price if you sign up for six month</p>
          <div class="standard-months-container justify-content-center mt-3">
            <div class="month-card">
              <p>6 month OG</p>
              <h3 class="pricing-text mt-2"><strong>R720</strong></h3>
              <p class="pricing-text">R120 per month</p>
              <div>
                <br>
                <%= button_to 'Select', subscriptions_path,
                params: { subscription: { plan: 'Standard', duration: '6'}, og: true, new: false  },
                method: :post,
                class: "sign-up-btn" %>
              </div>
            </div>
          </div>
          <p>Or...</p>
        <% end %>
        <div class="standard-months-container mt-3">
          <div class="month-card">
            <p>1 month</p>
            <h3 class="pricing-text mt-2"><strong>R260</strong></h3>
            <p class="pricing-text">R260 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: { subscription: { plan: 'Standard', duration: '1' }, og: false, new: false },
                method: :post,
                class: "sign-up-btn" %>
            </div>
          </div>
          <div class="month-card">
            <p>3 months</p>
            <h3 class="pricing-text mt-2"><strong>R660</strong></h3>
            <p class="pricing-text">R220 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'Standard', duration: '3' }, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
          <div class="month-card popular">
            <h4>Most popular</h4>
            <p>6 months</p>
            <h3 class="pricing-text mt-2"><strong>R1080</strong></h3>
            <p class="pricing-text">R180 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'Standard', duration: '6' }, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
          <div class="month-card popular">
            <p>1 year</p>
            <h3 class="pricing-text mt-2"><strong>R2160</strong></h3>
            <p class="pricing-text">R180 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'Standard', duration: '12' }, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
        </div>
        <h2 class="mt-5">XL Subscriptions</h2>
        <p>Pick a duration for a weekly pick up of 1 large bucket of compostable waste</p>
        <div class="standard-months-container mt-3">
          <div class="month-card">
            <p>1 month</p>
            <h3 class="pricing-text mt-2"><strong>R300</strong></h3>
            <p class="pricing-text">R300 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'XL', duration: '1' }, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
          <div class="month-card">
            <p>3 months</p>
            <h3 class="pricing-text mt-2"><strong>R810</strong></h3>
            <p class="pricing-text">R270 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'XL', duration: '3'}, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
          <div class="month-card">
            <p>6 months</p>
            <h3 class="pricing-text mt-2"><strong>R1440</strong></h3>
            <p class="pricing-text">R240 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'XL', duration: '6'}, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
        </div>
      </div>
    </section>
  <% end %>
</div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    <% unless current_user.og %>
      const discountInput = document.getElementById('discount-code-input');
      const forms = document.querySelectorAll('form[action="<%= subscriptions_path %>"]');

      forms.forEach(form => {
        form.addEventListener('submit', function(e) {
          // Only process discount code if the input exists (not on commercial renewal)
          if (discountInput) {
            const discountCode = discountInput.value.trim();

            if (discountCode) {
              // Create hidden input for discount code
              const hiddenInput = document.createElement('input');
              hiddenInput.type = 'hidden';
              hiddenInput.name = 'subscription[discount_code]';
              hiddenInput.value = discountCode;
              form.appendChild(hiddenInput);
            }
          }
        });
      });
    <% end %>
  });
</script>
