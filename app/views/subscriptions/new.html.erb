<div class="user-wrapper">
  <div class="collection-body">
    <h1 class="mt-4 mb-4">Pick a subscription option:</h1>
    <% if current_user.admin? %>
      <%= simple_form_for(@subscription) do |f| %>
        <%= f.input :customer_id %>
        <%= f.input :street_address, class: 'form-styling' %>
        <%= f.input :suburb %>
        <%= f.input :collection_day, as: :select, collection: Subscription.collection_days.keys.to_a %>
        <%= f.input :start_date, as: :date, html5: true %>
        <%= f.input :access_code %>
        <%= f.input :plan, label: "Choose a plan", collection: Subscription.humanized_plans.keys, include_blank: false, label_method: lambda { |key| Subscription.humanized_plans[key] } %>
        <%= f.input :duration, collection: %w[1 3 6] %>
        <%= f.button :submit, class:'gooi-button' %>
      <% end %>
    <% elsif current_user.subscriptions.where(plan: :Commercial).any? %>
      <p>Renew your commercial collection service</p>

      <% last_commercial = current_user.subscriptions.where(plan: :Commercial).order(created_at: :desc).first %>

      <div class="mb-4 mt-4" data-controller="commercial-pricing" data-commercial-pricing-renewal-value="true">
        <div class="row">
          <div class="col-md-6">
            <label class="form-label"><strong>Contract Duration</strong></label>
            <div class="mb-3">
              <div class="form-check">
                <%= radio_button_tag 'commercial_duration', '12', true, class: 'form-check-input', data: { action: 'commercial-pricing#calculate' }, id: 'commercial_duration_12' %>
                <%= label_tag 'commercial_duration_12', '12 months (R200/month)', class: 'form-check-label' %>
              </div>
              <div class="form-check">
                <%= radio_button_tag 'commercial_duration', '6', false, class: 'form-check-input', data: { action: 'commercial-pricing#calculate' }, id: 'commercial_duration_6' %>
                <%= label_tag 'commercial_duration_6', '6 months (R220/month)', class: 'form-check-label' %>
              </div>
              <div class="form-check">
                <%= radio_button_tag 'commercial_duration', '3', false, class: 'form-check-input', data: { action: 'commercial-pricing#calculate' }, id: 'commercial_duration_3' %>
                <%= label_tag 'commercial_duration_3', '3 months (R240/month)', class: 'form-check-label' %>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label"><strong>Buckets per collection (45L)</strong></label>
            <%= number_field_tag 'commercial_buckets', last_commercial.buckets_per_collection || 1,
                      min: 1, max: 20,
                      class: 'form-control mb-3',
                      data: { action: 'commercial-pricing#calculate', commercial_pricing_target: 'buckets' },
                      id: 'commercial_buckets_field' %>
            <small class="text-muted">Current: <%= last_commercial.buckets_per_collection %> buckets</small>
          </div>
        </div>

        <div class="mt-3 p-3 bg-light rounded" data-commercial-pricing-target="estimate">
          <p class="mb-1"><strong>Estimated cost:</strong></p>
          <p class="mb-0" data-commercial-pricing-target="price">Calculating...</p>
        </div>

        <%= button_to 'Renew Subscription', subscriptions_path,
                params: { subscription: { plan: 'Commercial', duration: '12', buckets_per_collection: last_commercial.buckets_per_collection || 1 }, og: false, new: false },
                method: :post,
                class: "sign-up-btn mt-3",
                id: 'commercial-renewal-form',
                data: { turbo: false } %>
      </div>
  <% else %>
    <section>
      <div class="subscription-rates-update">
        <% unless current_user.og %>
          <div class="mb-4 p-3 text-center" style="background-color: #f8f9fa; border-radius: 8px; margin: 0 auto">
            <label for="discount-code-input" class="form-label">Have a discount code?</label>
            <input type="text" id="discount-code-input" class="form-control" placeholder="Enter code" style="max-width: 300px;">
            <small class="text-muted">Optional - leave blank if you don't have one</small>
          </div>
        <% end %>
        <h2>Standard Subscriptions</h2>
        <p>Pick a duration for a weekly pick up of 1-2 bags of compostable waste</p>
        <% if current_user.og %>
          <p>As an Original Gooier you get our special price if you sign up for six month</p>
          <div class="standard-months-container justify-content-center mt-3">
            <div class="month-card">
              <p>6 month OG</p>
              <h3 class="pricing-text mt-2"><strong>R720</strong></h3>
              <p class="pricing-text">R120 per month</p>
              <div>
                <br>
                <%= button_to 'Select', subscriptions_path,
                params: { subscription: { plan: 'Standard', duration: '6'}, og: true, new: false  },
                method: :post,
                class: "sign-up-btn" %>
              </div>
            </div>
          </div>
          <p>Or...</p>
        <% end %>
        <div class="standard-months-container mt-3">
          <div class="month-card">
            <p>1 month</p>
            <h3 class="pricing-text mt-2"><strong>R260</strong></h3>
            <p class="pricing-text">R260 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: { subscription: { plan: 'Standard', duration: '1' }, og: false, new: false },
                method: :post,
                class: "sign-up-btn" %>
            </div>
          </div>
          <div class="month-card">
            <p>3 months</p>
            <h3 class="pricing-text mt-2"><strong>R660</strong></h3>
            <p class="pricing-text">R220 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'Standard', duration: '3' }, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
          <div class="month-card popular">
            <h4>Most popular</h4>
            <p>6 months</p>
            <h3 class="pricing-text mt-2"><strong>R1080</strong></h3>
            <p class="pricing-text">R180 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'Standard', duration: '6' }, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
          <div class="month-card popular">
            <p>1 year</p>
            <h3 class="pricing-text mt-2"><strong>R2160</strong></h3>
            <p class="pricing-text">R180 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'Standard', duration: '12' }, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
        </div>
        <h2 class="mt-5">XL Subscriptions</h2>
        <p>Pick a duration for a weekly pick up of 1 large bucket of compostable waste</p>
        <div class="standard-months-container mt-3">
          <div class="month-card">
            <p>1 month</p>
            <h3 class="pricing-text mt-2"><strong>R300</strong></h3>
            <p class="pricing-text">R300 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'XL', duration: '1' }, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
          <div class="month-card">
            <p>3 months</p>
            <h3 class="pricing-text mt-2"><strong>R810</strong></h3>
            <p class="pricing-text">R270 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'XL', duration: '3'}, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
          <div class="month-card">
            <p>6 months</p>
            <h3 class="pricing-text mt-2"><strong>R1440</strong></h3>
            <p class="pricing-text">R240 per month</p>
            <div>
              <br>
              <%= button_to 'Select', subscriptions_path,
                params: {subscription: { plan: 'XL', duration: '6'}, og: false, new: false }, method: :post, class: "sign-up-btn"  %>
            </div>
          </div>
        </div>
      </div>
    </section>
  <% end %>
</div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    <% unless current_user.og %>
      const discountInput = document.getElementById('discount-code-input');
      const forms = document.querySelectorAll('form[action="<%= subscriptions_path %>"]');

      forms.forEach(form => {
        form.addEventListener('submit', function(e) {
          const discountCode = discountInput.value.trim();

          if (discountCode) {
            // Create hidden input for discount code
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'subscription[discount_code]';
            hiddenInput.value = discountCode;
            form.appendChild(hiddenInput);
          }
        });
      });
    <% end %>

    // Commercial renewal form dynamic updates
    const commercialForm = document.getElementById('commercial-renewal-form');
    if (commercialForm) {
      const durationRadios = document.querySelectorAll('input[name="commercial_duration"]');
      const bucketsInput = document.getElementById('commercial_buckets_field');

      function updateCommercialForm() {
        const selectedDuration = document.querySelector('input[name="commercial_duration"]:checked')?.value || '12';
        const selectedBuckets = bucketsInput?.value || '1';

        // Update form params
        const durationInput = commercialForm.querySelector('input[name="subscription[duration]"]');
        const bucketsParamInput = commercialForm.querySelector('input[name="subscription[buckets_per_collection]"]');

        if (durationInput) durationInput.value = selectedDuration;
        if (bucketsParamInput) bucketsParamInput.value = selectedBuckets;
      }

      durationRadios.forEach(radio => {
        radio.addEventListener('change', updateCommercialForm);
      });

      if (bucketsInput) {
        bucketsInput.addEventListener('input', updateCommercialForm);
      }

      // Initial update
      updateCommercialForm();
    }
  });
</script>
