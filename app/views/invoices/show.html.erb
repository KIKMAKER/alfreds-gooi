<div class="invoice-wrapper">
  <div class="invoice-container">
    <div class="d-flex justify-content-between align-items-center mb-4 link-decoration">
      <h1 class="mb-0">Invoice</h1>
      <% if current_user.admin? %>
        <%= link_to "Edit Invoice", edit_invoice_path(@invoice), class: "link-text" %>
      <% end %>
    </div>
    <!--<h5 class="text-center my-3">gooi compost collections</h5>-->
    <div class="user-details ms-1 ">
      <div class="user me-4">
        <p><strong>For:</strong> <%= @subscription.user.first_name %> <%= @subscription.user.last_name %></p>
        <p><strong>Email:</strong> <%= @subscription.user.email %></p>
        <p><strong>Customer ID:</strong> <%= @subscription.customer_id %>
          <p><strong>Address:</strong> <%= @subscription.short_address %>, <%= @subscription.suburb %></p>
          <p><strong>Due Date:</strong> <%= @invoice.paid ? 'paid!' : @invoice.due_date.strftime('%A, %b %d') %></p>
          <% if current_user.admin? && !@invoice.paid %>
            <%= link_to 'paid', paid_invoice_path(@invoice) %>
          <% end %>
        </div>
        <div class="business">
          <% if @subscription.business_profile.present? %>
              <p><strong>Business:</strong> <%= @subscription.business_profile.business_name %></p>
              <% if @subscription.business_profile.vat_number.present? %>
                <p><strong>VAT #:</strong> <%= @subscription.business_profile.vat_number %></p>
              <% end %>
              <% if @subscription.business_profile.contact_person.present? %>
                <p><strong>Att:</strong> <%= @subscription.business_profile.contact_person %></p>
              <% end %>
              <%= link_to "Edit Business Details", edit_subscription_business_profile_path(@subscription), class: "link-title text-warning", style: "font-size:0.64rem; font-weight:bold" %>
          <% else %>

            <div class="mb-2">
              <p>Need an invoice for your business?</p>
              <%= link_to "Add details", new_subscription_business_profile_path(@subscription), class: "submit-btn" %>
            </div>
          <% end %>
        </div>
      </div>
      <div class="invoice-table">
        <!--<p><%#= @subscription.duration %> month <%= @subscription.plan %> gooi subscription </p>-->
        <div class="header">
          <div class="quantity-description">
            <div class="quantity">
              <h1>Quantity</h1>
            </div>
            <h1>Item</h1>
          </div>
          <h1>Amount</h1>
        </div>
        <% @invoice.invoice_items.each do |item| %>
          <div class="invoice-item">
            <div class="quantity-description">
              <div class="quantity">
                <p><%= item.quantity.to_i %></p>
              </div>
              <% if item.product.title.start_with?("Volume Processing per 45L") %>
                <% rate_per_bucket = item.product.price %>
                <% buckets_per_collection = (item.amount / rate_per_bucket).to_i %>
                <% liters_per_collection = buckets_per_collection * 45 %>
                <% rate_per_liter = item.amount.to_f / liters_per_collection %>
                <p>Volume Processing (<%= liters_per_collection %>L per collection) @ R<%= '%.2f' % rate_per_liter %>/L</p>
              <% elsif item.product.title.start_with?("Volume Processing per 25L") %>
                <% rate_per_bucket = item.product.price %>
                <% buckets_per_collection = (item.amount / rate_per_bucket).to_i %>
                <% liters_per_collection = buckets_per_collection * 25 %>
                <% rate_per_liter = item.amount.to_f / liters_per_collection %>
                <p>Volume Processing (<%= liters_per_collection %>L per collection) @ R<%= '%.2f' % rate_per_liter %>/L</p>
              <% elsif item.product.title.start_with?("Commercial Starter Buckets") %>
                <p><%= item.product.title %> @ R<%= item.amount.truncate %> each</p>
              <% elsif item.product.title.start_with?("Weekly Collection Service") %>
                <p><%= item.product.title %> @ R<%= item.amount.truncate %>/month</p>
              <% else %>
                <p><%= item.product.title %> <% if item.quantity > 1 %>(R<%= item.amount.truncate %> each)<% end %></p>
              <% end %>
            </div>
            <p>R<%= (item.amount * item.quantity).truncate %></p>
          </div>
        <% end %>
        <% @invoice.invoice_discount_codes.each do |invoice_discount| %>
          <div class="invoice-item">
            <div class="quantity-description">
              <div class="quantity">
                <p>1</p>
              </div>
              <p><%= invoice_discount.discount_code.code %> Discount</p>
            </div>
            <p class="text-success">
              -R<%= '%.2f' % invoice_discount.discount_amount %>
            </p>
          </div>
        <% end %>
      </div>
      <div class="invoice-total">
        <p>Total: R<%= @invoice.total_amount.truncate %></p>
      </div>
      <div class="payment-container">
        <h2>Make a Payment</h2>
        <div class="payment-options">
          <div class="eft w-50 me-4">
            <h3 class="mb-3">Bank Details</h3>
            <p><strong>Bank:</strong> FNB</p>
            <p><strong>Account Name:</strong> Gooi</p>
            <p><strong>Account Number:</strong> 63066225426</p>
            <p><strong>Branch Code:</strong> 250655</p>
            <p><strong>Reference:</strong> Invoice #<%= @invoice.id %> - <%= @subscription.customer_id %></p>

            <p>Please use the reference above when making payment.</p>
          </div>
          <div class="snapscan">
            <h3 class="mb-3">Snapscan</h3>
            <p class="mb-5">Make payment via the secure SnapScan portal. <br>SnapScan accepts bank cards as well as payments through the SnapScan app.</p>
            <%= link_to "Pay with snapscan", "https://pos.snapscan.io/qr/8jQ1QVVb?id=#{@subscription.customer_id}&amount=#{@invoice.total_amount.to_i}00&invoice_id=#{@invoice.id}", target:"blank", class: "small-yellow-btn"  %>

          </div>
        </div>
      </div>
    </div>
  </div>
