<div class="container mt-4">
  <h1>New Quotation</h1>

  <%= simple_form_for @quotation, html: { class: 'mt-4' } do |f| %>
    <%= f.error_notification %>

    <div class="row">
      <div class="col-md-6">
        <h3>Customer or Prospect</h3>

        <%= f.association :user,
            collection: @users,
            label_method: lambda { |u| "#{u.first_name} #{u.last_name} (#{u.email})" },
            prompt: "Select existing customer (optional)",
            input_html: { class: 'select2' } %>

        <div class="mt-3">
          <p class="text-muted">OR enter prospect details:</p>
          <%= f.input :prospect_name, label: "Prospect Name" %>
          <%= f.input :prospect_email, label: "Prospect Email" %>
          <%= f.input :prospect_phone, label: "Prospect Phone" %>
          <%= f.input :prospect_company, label: "Company Name (optional)" %>
        </div>
      </div>

      <div class="col-md-6">
        <h3>Quotation Details</h3>
        <%= f.input :created_date, as: :date, input_html: { value: Date.today } %>
        <%= f.input :expires_at, as: :date, label: "Expires On",
            input_html: { value: Date.today + 30.days } %>
        <%= f.input :status, collection: Quotation.statuses.keys,
            selected: 'draft', include_blank: false %>
        <%= f.input :notes, as: :text, input_html: { rows: 3 } %>
      </div>
    </div>

    <hr class="my-4">

    <h3>Products</h3>
    <p class="text-muted">Enter quantities for products to include in this quotation:</p>

    <%= f.simple_fields_for :quotation_items do |item_fields| %>
      <div class="row mb-2">
        <% @products.each do |product| %>
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title"><%= product.title %></h5>
                <p class="card-text">R<%= product.price.to_i %></p>
                <%= item_fields.hidden_field :product_id, value: product.id %>
                <%= item_fields.input :quantity,
                    label: "Quantity",
                    input_html: { min: 0, step: 0.1, value: 0 } %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="mt-4">
      <%= f.button :submit, 'Create Quotation', class: 'btn btn-primary' %>
      <%= link_to 'Cancel', quotations_path, class: 'btn btn-secondary' %>
    </div>
  <% end %>
</div>
