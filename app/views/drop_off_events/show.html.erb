<div class="container driver-wrapper my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1><%= @drop_off_event.drop_off_site.name %></h1>
      <p class="text-muted mb-0"><%= @drop_off_event.drop_off_site.street_address %>, <%= @drop_off_event.drop_off_site.suburb %></p>
    </div>
    <% if @drop_off_event.is_done %>
      <span class="badge bg-success">Completed</span>
      <%= link_to 'End the day', end_drivers_day_path(@drivers_day), class:"link-title text-success"  %>
    <% else %>
      <%= link_to "Mark Complete", complete_drivers_day_drop_off_event_path(@drivers_day, @drop_off_event),
          data: { turbo_method: :post, turbo_confirm: "Mark this drop-off as complete?" },
          class: "submit-btn" %>
    <% end %>
  </div>

  <div class="row g-3">
    <!-- Left: Entry form -->
    <div class="col-12 col-lg-6">
      <div class="card p-3" style="border-radius:1em">
        <h5 class="mb-3">Weigh a bucket</h5>

        <%= simple_form_for [@drivers_day, @drop_off_event, @drop_off_event.buckets.build],
            url: drivers_day_drop_off_event_buckets_path(@drivers_day, @drop_off_event) do |f| %>

          <%= f.input :gross_kg,
                label: "Scale reading (kg, incl. bucket/tare)",
                input_html: { step: 0.01, min: 0, autofocus: true },
                hint: "We'll subtract #{Bucket::TARE_KG} kg automatically." %>

          <%= f.input :bucket_size,
                as: :radio_buttons,
                collection: [[25, '25L'], [45, '45L']],
                label: "Bucket size",
                item_wrapper_class: 'form-check form-check-inline radio-buttons',
                wrapper_html: { class: 'mb-3' } %>

          <%= f.input :half,
                as: :boolean,
                label: "Half-full bucket" %>

          <div class="mt-2">
            <%= f.button :submit, "Save & add next", class: "submit-btn" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Right: Summary -->
    <div class="col-12 col-lg-6">
      <div class="card p-3" style="border-radius:1em">
        <h5 class="mb-3">Drop-off totals</h5>
        <div class="row text-center">
          <div class="col-6 col-md-3 mb-2">
            <div class="text-muted">Buckets</div>
            <div class="fs-4 fw-bold"><%= @buckets.count %></div>
          </div>
          <div class="col-6 col-md-3 mb-2">
            <div class="text-muted">Net kg</div>
            <div class="fs-4 fw-bold"><%= number_with_precision(@drop_off_event.total_weight_from_buckets, precision: 2) %></div>
          </div>
          <div class="col-6 col-md-3 mb-2">
            <div class="text-muted">Full-equiv</div>
            <div class="fs-4 fw-bold"><%= number_with_precision(@drop_off_event.full_equivalent_count, precision: 2) %></div>
          </div>
          <div class="col-6 col-md-3 mb-2">
            <div class="text-muted">Avg kg / bucket</div>
            <div class="fs-4 fw-bold"><%= number_with_precision(@drop_off_event.avg_weight_per_bucket, precision: 2) %></div>
          </div>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted">Avg kg / full-equivalent: <%= number_with_precision(@drop_off_event.avg_weight_per_full_equiv, precision: 2) %></small>
        </div>
      </div>
    </div>
  </div>

  <!-- Table of buckets -->
  <div class="card p-3 mt-3" style="border-radius:1em">
    <h5 class="mb-2">Weighed buckets</h5>
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>#</th>
          <th>Size</th>
          <th>Net kg</th>
          <th>Half?</th>
          <th>Added</th>
          <th class="text-end"></th>
        </tr>
      </thead>
      <tbody>
        <% @buckets.each_with_index do |b, i| %>
          <tr class="align-middle">
            <td><%= i + 1 %></td>
            <td><%= b.bucket_size %>L</td>
            <td><%= number_with_precision(b.weight_kg, precision: 3) %></td>
            <td><%= b.half? ? "Yes" : "No" %></td>
            <td><%= l b.created_at, format: :short %></td>
            <td class="text-end">
              <%= link_to drivers_day_drop_off_event_bucket_path(@drivers_day, @drop_off_event, b),
                          data: { turbo_method: :delete, turbo_confirm: "Delete this entry?" },
                          class: "text-danger text-decoration-none", title: "Delete", aria: { label: "Delete" } do %>
                <i class="fa-solid fa-trash" style="font-size=1rem"></i>
              <% end %>
            </td>
          </tr>
        <% end %>
        <% if @buckets.empty? %>
          <tr><td colspan="6" class="text-center text-muted">No buckets weighed yet.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <%= link_to "â† Back to route", today_subscriptions_path, class: "btn btn-outline-secondary" %>
  </div>
</div>
