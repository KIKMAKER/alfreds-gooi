<div class="driver-wrapper">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1><%= @drivers_day.date.strftime('%A, %B %d, %Y') %> done!</h1>
    <%= link_to "Edit", edit_drivers_day_path(@drivers_day), class: "btn btn-sm btn-outline-secondary" %>

  </div>

  <% if @stat %>

    <div class="mb-4">
      <strong>
        <p>Time: <%= @drivers_day.start_time&.strftime('%I:%M %p') %> - <%= @drivers_day.end_time&.strftime('%I:%M %p') %>
          <% if @stat.route_hours %>
            (<%= number_with_precision(@stat.route_hours, precision: 1) %>h)
          <% end %>
        </p>
      </strong>
      <strong>
        <p>Distance: <%= @drivers_day.start_kms %> → <%= @drivers_day.end_kms %> km
          <% if @stat.kms %>
            (<%= @stat.kms %> km total)
          <% end %>
        </p>
      </strong>
      <%= link_to "buckets", drivers_day_buckets_path(@drivers_day) %>
    </div>

    <div>
      <h3>Collection Stats</h3>
      <div class="row g-3 my-3 text-center">
        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Net kg</div>
            <div class="fs-4 fw-bold"><%= number_with_precision(@stat.net_kg, precision: 2) %></div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Buckets (F / H)</div>
            <div class="fs-6 fw-bold">
              <%= @stat.bucket_count %>
              <small class="text-muted">(<%= @stat.full_count %> / <%= @stat.half_count %>)</small>
            </div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Full-equiv</div>
            <div class="fs-4 fw-bold"><%= number_with_precision(@stat.full_equiv, precision: 2) %></div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Avg kg / bucket</div>
            <div class="fs-4 fw-bold"><%= number_with_precision(@stat.avg_kg_bucket, precision: 2) %></div>
            <small class="text-muted">per full-equiv: <%= number_with_precision(@stat.avg_kg_full, precision: 2) %></small>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Households</div>
            <div class="fs-4 fw-bold"><%= @stat.households %></div>
            <small class="text-muted">Bags: <%= @stat.bags_sum %></small>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Route time</div>
            <div class="fs-4 fw-bold">
              <% if @stat.route_hours %>
                <%= number_with_precision(@stat.route_hours, precision: 2) %> h
              <% else %>—<% end %>
            </div>
            <small class="text-muted">
              <% if @stat.stops_per_hr %>
                <%= number_with_precision(@stat.stops_per_hr, precision: 2) %> stops/h ·
                <%= number_with_precision(@stat.kg_per_hr, precision: 2) %> kg/h
              <% else %>—<% end %>
            </small>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Distance</div>
            <div class="fs-4 fw-bold">
              <% if @stat.kms %>
                <%= @stat.kms %> km
              <% else %>—<% end %>
            </div>
            <small class="text-muted">
              <% if @stat.kg_per_km %>
                <%= number_with_precision(@stat.kg_per_km, precision: 2) %> kg/km
              <% else %>—<% end %>
            </small>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">CO₂e Impact</div>
            <div class="fs-6 fw-bold text-success">
              <%= number_with_precision(@stat.net_co2e_kg, precision: 1) %> kg
            </div>
            <small class="text-muted d-block">Avoided: <%= number_with_precision(@stat.avoided_co2e_kg, precision: 1) %></small>
            <small class="text-muted d-block">Driving: <%= number_with_precision(@stat.driving_co2e_kg, precision: 1) %></small>
          </div>
        </div>
      </div>

      <br>
    </div>

    <% if @drivers_day.note.present? %>
      <div class="card p-3 mb-4" style="border-radius:1em; background-color: #fff3cd;">
        <h5>Note:</h5>
        <p class="mb-0"><%= @drivers_day.note %></p>
      </div>
    <% end %>

    <% if @drivers_day.message_from_alfred.present? %>
      <div class="card p-3 mb-4" style="border-radius:1em; background-color: #d1ecf1;">
        <h5>Message from Alfred:</h5>
        <p class="mb-0"><%= @drivers_day.message_from_alfred %></p>
      </div>
    <% end %>
    <h3 class="mb-3">Customer Stats</h3>

    <%= render 'daily_snapshot' %>

  <% else %>
    <div class="alert alert-warning">
      <strong>No statistics calculated yet.</strong>
      <p>Stats are calculated when the day is completed in the "End Day" flow.</p>
    </div>

    <div class="mb-4">
      <strong>
        <p>Time: <%= @drivers_day.start_time&.strftime('%I:%M %p') || '—' %> - <%= @drivers_day.end_time&.strftime('%I:%M %p') || '—' %></p>
      </strong>
      <strong>
        <p>Distance: <%= @drivers_day.start_kms || '—' %> → <%= @drivers_day.end_kms || '—' %> km</p>
      </strong>
      <strong>
        <p>Buckets: <%= @drivers_day.total_buckets || '—' %> - <%= link_to 'view', drivers_day_buckets_path(@drivers_day)  %>
        </p>
      </strong>
    </div>
  <% end %>

  <br>
  <div class="d-flex gap-2 mb-3">
    <%= link_to "All Days", drivers_days_path, class: "submit-btn" %>
    <%= link_to "View Collections", collections_drivers_day_path(@drivers_day), class: "submit-btn" %>
  </div>
</div>
