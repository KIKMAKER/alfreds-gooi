<div class="driver-wrapper">
  <!--Alfred can start the day-->
  <% if current_user.driver? && !@drivers_day.id.nil? && @drivers_day.end_time.nil? %>
    <h1 class="text-center">Good morning <%= current_user.first_name %></h1>
    <h4>It's <%= @today %> today</h4>
    <br>
    <!--It's not a gooi day-->
    <% if @collections.empty? %>
      <h2>There are no subscriptions waiting for you.</h2>
      <p>But I love that you checked...</p>
      <!--It's a gooi day-->
    <% else %>
      <p class="text-center">There <%= @count == 1 ? 'is' : 'are' %> <%= pluralize(@count, 'parcel') %> waiting to be collected</p>
      <% if @new_customers&.any? %>
        <p>and <%= pluralize(@new_customers.count, 'new customer') %> to meet!</p>
        <h5 class="mt-3">They are:</h5>
        <% @new_customers.each do |collection| %>
          <p><%= collection.subscription.user.first_name %> at <%= collection.subscription.street_address %> </p>
          <p>Let them know you are coming past:</p>
          <%= link_to collection.subscription.user.generate_whatsapp_link("Hello from gooi! I will be coming past today to drop off your starter kit. Please add this number to your contacts so that you can recieve our weekly reminders about collection day. Welcome to gooi! It's a joy to have you onboard."), target: :_blank do %>
            <i class="fa-brands fa-whatsapp" style="font-size: 30px"></i>
          <% end %>
        <% end %>
        <strong>
          <p class="mt-3">Take <%= pluralize(@new_customers.count, 'bucket') %> for them!</p>
        </strong>
        <!--<p>Don't forget their bucket.</p>-->
      <% end %>
    <% end %>
    <% unless @drivers_day.note_nil_zero? %>
      <p>Note for the day: <%= @drivers_day.note %></p>
    <% end %>
    <h5 class="mt-3">Ready to get started?</h5>
    <br>
    <!--<div class="submit-btn">-->
    <%= link_to "Start", start_drivers_day_path(@drivers_day), class: "submit-btn mb-5" %>
    <!--</div>-->
    <!--Alfred has finished the day-->
  <%elsif current_user.driver? && @drivers_day&.respond_to?(:end_time) && @drivers_day.end_time && @drivers_day&.persisted? %>
    <br>
    <h1>Thank you for your work today</h1>
    <br>
    <%= image_tag'Alfred Sticker.svg', class: 'avatar-large' %>
    <br>
    <br>
    <% if @drivers_day.end_kms.nil? %>
      <p>The end kms didn't save or weren't entered</p>
      <%= simple_form_for @drivers_day do |f| %>
        <%= f.input :end_kms, label: "End kms", required: true, input_html: { min: 0 } %>
        <%= f.submit "Save kms", class: "gooi-button" %>
      <% end %>
    <% else %>
      <!--<p>You drove <%#= @drivers_day.end_kms - @drivers_day.start_kms %>kms today</p>-->
      <p>We planted the equivalent of <%= number_with_precision(@impact[:trees_net], precision: 2) %> tress</p>

      <small class="text-muted d-block">
        From waste: <%= number_with_precision(@impact[:trees_gross], precision: 2) %>
      </small>
      <small class="text-muted d-block">
        To offset driving: <%= number_with_precision(@impact[:trees_to_offset_drive], precision: 2) %>
      </small>

    <% end %>
    <% unless @drivers_day.start_time && @drivers_day.end_time%>
      <p>Seems the start/end time of your day wasn't saved</p>
      <p>Please enter them here:</p>
      <%= simple_form_for @drivers_day do |f| %>
        <%= f.input :start_time, label: "Start time", required: true %>
        <%= f.input :end_time, label: "End time", required: true %>
        <%= f.submit "Save times", class: "gooi-button" %>
      <% end %>
    <% else %>
      <!--<p>And worked for <%#= @hours_worked %></p>-->

    <% end %>
    <p>Travel safe, see you next time</p>
    <div>
      <br>
      <div class="row g-3 my-3 text-center">
        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Net kg</div>
            <div class="fs-4 fw-bold"><%= number_with_precision(@stats[:net_kg], precision: 2) %></div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Buckets (F / H)</div>
            <div class="fs-6 fw-bold">
              <%= @stats[:bucket_count] %>
              <small class="text-muted">(<%= @stats[:full_count] %> / <%= @stats[:half_count] %>)</small>
            </div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Full-equiv</div>
            <div class="fs-4 fw-bold"><%= number_with_precision(@stats[:full_equiv], precision: 2) %></div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Avg kg / bucket</div>
            <div class="fs-4 fw-bold"><%= number_with_precision(@stats[:avg_kg_bucket], precision: 2) %></div>
            <small class="text-muted">per full-equiv: <%= number_with_precision(@stats[:avg_kg_full], precision: 2) %></small>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Households</div>
            <div class="fs-4 fw-bold"><%= @stats[:households] %></div>
            <small class="text-muted">Bags: <%= @stats[:bags_sum] %></small>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Route time</div>
            <div class="fs-4 fw-bold">
              <% if @stats[:route_hours] %>
                <%= number_with_precision(@stats[:route_hours], precision: 2) %> h
              <% else %>—<% end %>
            </div>
            <small class="text-muted">
              <% if @stats[:stops_per_hr] %>
                <%= number_with_precision(@stats[:stops_per_hr], precision: 2) %> stops/h ·
                <%= number_with_precision(@stats[:kg_per_hr], precision: 2) %> kg/h
              <% else %>—<% end %>
            </small>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3" style="border-radius:1em">
            <div class="text-muted">Distance</div>
            <div class="fs-4 fw-bold">
              <% if @stats[:kms] %>
                <%= @stats[:kms] %> km
              <% else %>—<% end %>
            </div>
            <small class="text-muted">
              <% if @stats[:kg_per_km] %>
                <%= number_with_precision(@stats[:kg_per_km], precision: 2) %> kg/km
              <% else %>—<% end %>
            </small>
          </div>
        </div>
      </div>

      <br>
    </div>
    <%= link_to "View all todays collections", today_subscriptions_path, class: "small-yellow-btn" %>
  <% elsif @drivers_day.nil? && current_user.driver? %><!--Alfred can't start the day-->
    <h1>Seems something went wrong when the collections were loaded</h1>
    <p>Please ask Kiki to update collections</p>
    <%# elsif current_user.driver? %><!--Alfred is starting the day-->
  <% elsif current_user.admin? && !Collection.exists?(date: Date.today) %>
    <%= link_to "load the collections, babe", load_csv_collections_path, class: "collection-button" %>
  <% else %>
    <h1>Good morning <%= current_user.first_name %></h1>
    <h4>It's <%= @today %> today</h4>
    <p>View all <%= link_to "past days", drivers_days_path %></p>
  <% end %>
</div>
