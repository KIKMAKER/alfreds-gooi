<div class="user-wrapper link-decoration">
  <div>
    <% if @unpaid_invoice %>
      <div class="container text-center">
        <h1>Hello <%= current_user.first_name %></h1>
        <%= image_tag'Alfred Sticker.svg', class: 'avatar-large my-3' %>
        <h2>You have an unpaid invoice</h2>
        <p class="mb-4">Please settle your account to continue gooiing</p>
        <%= link_to "View invoice", invoice_path(@unpaid_invoice), class:"small-yellow-btn" %>
      </div>
    <% elsif @subscriptions.count > 1 %>
      <!-- Multi-location management -->
      <div class="container">
        <h1 class="text-center my-4">Manage Your Locations</h1>

        <div class="table-responsive">
          <table class="white-table table table-hover">
            <thead>
              <tr>
                <th>Location</th>
                <th>Next Collection</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @subscriptions.each do |sub| %>
                <% next_collection = sub.collections.where('date >= ?', Date.today).order(date: :asc).first %>
                <tr>
                  <td>
                    <strong><%= sub.short_address %></strong><br>
                    <small class="text-muted"><%= sub.suburb %></small>
                    <% if sub.holiday_end && sub.holiday_end >= Date.today %>
                      <span class="badge bg-info">On Holiday</span><br>
                      <small>Until <%= sub.holiday_end.strftime("%d %b") %></small>
                    <% elsif next_collection&.skip %>
                      <span class="badge bg-warning text-dark">Skip Next</span>
                    <% else %>
                      <span class="badge bg-success">Active</span>
                    <% end %>
                  </td>
                  <td>
                    <% if next_collection %>
                      <%= next_collection.date.strftime("%a %d %b") %>
                      <% if next_collection.skip %>
                        <br>
                        <span class="badge bg-warning text-dark">Skipped</span>
                      <% end %>
                    <% elsif sub.is_new_customer %>
                      <span class="text-muted">Starter kit delivery</span>
                    <% else %>
                      <span class="text-muted">No upcoming</span>
                    <% end %>
                  </td>
                  <td>
                    <div class="btn-group-vertical btn-group-sm" role="group">
                      <% if next_collection && !next_collection.skip %>
                        <%= button_to "Skip Next", pause_subscription_path(sub), class: "tiny-yellow-btn", method: :post, data: {turbo: false} %>
                      <% elsif next_collection&.skip %>
                        <%= button_to "Unskip", unpause_subscription_path(sub), class: "tiny-yellow-btn", method: :post, data: {turbo: false} %>
                      <% end %>
                      <button type="button" class="tiny-yellow-btn mt-2" data-bs-toggle="modal" data-bs-target="#holidayModal<%= sub.id %>">
                        <%= sub.holiday_end && sub.holiday_end >= Date.today ? "Edit Holiday" : "Plan Holiday" %>
                      </button>
                    </div>
                  </td>
                </tr>

                <!-- Holiday Modal for this subscription -->
                <div class="modal fade" id="holidayModal<%= sub.id %>" tabindex="-1" aria-labelledby="holidayModalLabel<%= sub.id %>" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="holidayModalLabel<%= sub.id %>">
                          <%= sub.holiday_end && sub.holiday_end >= Date.today ? "Edit Holiday" : "Plan Holiday" %>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <% if sub.holiday_end && sub.holiday_end >= Date.today %>
                          <div class="mb-3">
                            <p><strong>Current Holiday:</strong></p>
                            <p><%= sub.holiday_start.strftime("%a %d %b") %> - <%= sub.holiday_end.strftime("%a %d %b") %></p>
                            <%= button_to "Cancel Holiday", clear_holiday_subscription_path(sub), class: "btn btn-danger btn-sm mb-3", method: :post, data: {turbo: false} %>
                          </div>
                          <hr>
                        <% end %>

                        <p class="text-muted">We will automatically skip collections while you're away.</p>
                        <%= simple_form_for sub, url: holiday_dates_subscription_path(sub), method: :patch do |f| %>
                          <%= f.input :holiday_start,
                              as: :string,
                              input_html: { data: { controller: "datepicker" } },
                              label: "Start Date:" %>
                          <%= f.input :holiday_end,
                              as: :string,
                              input_html: { data: { controller: "datepicker" } },
                              label: "End Date:" %>
                          <%= f.submit "Save Holiday", class: "small-yellow-btn" %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </tbody>
          </table>
        </div>

        <div class="mt-4 text-center">
          <p class="my-2 link-decoration align-center">
            <%= link_to "https://wa.me/27785325513?text=I%27m+ready+to+start+gooiing",
                   target: "_blank" do %>
              <i class="fa-brands fa-whatsapp"></i>
              Chat to Alfred
            <% end %>
          </p>
        </div>

        <div class="mt-5">
          <h2 class="text-center">Recent Collections</h2>
          <% if @recent_collections.any? %>
            <%= render "past_collections", collections: @recent_collections %>
            <%= link_to "View All Collections", collections_history_path, class: "d-block text-center mt-3" %>
          <% else %>
            <p class="text-center">You haven't had any collections yet</p>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="text-center my-2">
        <h2 class="mb-4">Upcoming Collection</h2>
        <% if @next_collection&.skip %>
          <p class="mb-3">Alfred will skip you <%= Date.today.wday < 5 ? "this" : "next" %> week</p>
          <%= button_to "Unskip Me!", unpause_subscription_path(@subscription), class: "submit-btn", data: {turbo: false}  %>
        <% elsif @subscription.is_new_customer %>
          <div class="contact-section">
            <h3>Get ready to start gooiing!</h3>
            <div class="contact-links">
              <p class="mb-3">Alfred will deliver your starter kit <%= Date.today.wday < 5 ? "this" : "next" %> week.</p>
              <p>Please add us to your contacts list and feel free to get in touch with any comments or questions.</p>
              <p class="my-2 link-decoration align-center">
                <%= link_to "https://wa.me/27785325513?text=I%27m+ready+to+start+gooiing",
                   target: "_blank" do %>
                  <i class="fa-brands fa-whatsapp"></i>
                  Start the conversation
                <% end %>
              </p>
            </div>
          </div>
        <% else %>
          <p class="my-2 link-decoration align-center">

            <% if @next_collection && @next_collection.date >= Date.today %>
              <h3 class="mb-3">Your next collection is on <%= @subscription.collections&.last.date&.strftime("%A %d %B") %></h3>
              <p>Don't need collection? <br>
                Help Alfred plan by clicking skip below</p>
              <%= button_to "Skip me", pause_subscription_path(@subscription), class: "submit-btn align-self-start my-3", data: {turbo: false} %>

              <%= link_to "https://wa.me/27785325513",
                   target: "_blank" do %>
                <i class="fa-brands fa-whatsapp"></i>
              <% end %>
              <p class="link-text">Chat to Alfred</p>
              <%# unless @subscription.collections.empty? %>
              <!--                <div class="mt-4">
                  <p class="mb-2">Need to pass on a message?</p>
                  <%#= simple_form_for @subscription.collections&.last, url: add_customer_note_collection_path(@subscription.collections&.last), method: :post do |f| %>-->
              <%#= f.input :customer_note, value: @subscription.collections&.last.customer_note, label: false, placeholder: "Add a note for Alfred..." %>
              <%#= f.button :submit, "Save Note", class: "submit-btn mt-2" %>
              <%# end %>
              <!--                </div>-->
              <%# end %>
              <div class="user-holiday-container my-4" data-controller="toggle">
                <% if @subscription.holiday_end.nil? || @subscription.holiday_end < Date.today %>
                  <h3>Need to skip more than one week?</h3>
                  <button class="submit-btn mt-3" data-action="toggle#fire" data-toggle-target="button">Plan a holiday</button>
                  <div class="card-white d-none position-relative" data-toggle-target="form">
                    <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-action="click->toggle#fire" aria-label="Close"></button>
                    <p class="m-2">Enter your holiday dates and we will skip automatically skip you while you are away.</p>
                    <%= simple_form_for @subscription do |f| %>
                      <%= f.input :holiday_start,
                          as: :string,
                          input_html: { data: { controller: "datepicker" } }, label: "Start:" %>
                      <%= f.input :holiday_end,
                          as: :string,
                          input_html: { data: { controller: "datepicker" } }, label: "End:" %>
                      <%= f.submit "save", class: "submit-btn" %>
                    <% end %>
                  </div>
                <% else %>
                  <h2>Upcoming Holiday</h2>
                  <div class="mt-4 container-flex flex-column">
                    <p><%= @subscription.holiday_start.strftime("%a %d %b") %> - <%= @subscription.holiday_end.strftime("%a %d %b") %></p>
                    <%= button_to "Cancel", clear_holiday_subscription_path(@subscription), class: "submit-btn mt-2", data: {turbo: false} %>
                  </div>
                <% end %>
              </div>
            <% else %>
              <p class="mb-3">Your last collection was on <%= @subscription.collections&.last&.date&.strftime("%A %d %B") || @subscription.start_date.strftime("%A %d %B") %></p>
            <% end %>
          <% end %>

        </div>
        <% if @days_left <= 0 %>
          <div class="mt-4 container-flex flex-column text-center align-items-center">
            <p>Your subscription has come to an end (<%= @days_left %> pick ups).</p>
            <p>Click below to continue gooiing</p>
            <%= link_to "Resubscribe", new_subscription_path, class: "submit-btn mt-2 w-50" %>
          </div>
        <% elsif @days_left < 2 %>
          <div class="mt-4 container-flex flex-column text-center align-items-center">
            <p>Your subscription will come to an end in <%= pluralize((@days_left/4.2).ceil, 'month') %> (<%= @days_left %> pick ups).</p>
            <%= link_to "Resubscribe", new_subscription_path, class: "submit-btn mt-2 w-50" %>
          </div>
        <% else %>
          <div class="mt-4 container-flex flex-column text-center align-items-center">
            <p>Your subscription will come to an end in <%= pluralize((@days_left/4.2).ceil, 'month') %> (<%= @days_left %> pick ups).</p>
          </div>
        <% end %>
        <div class="mt-5">
          <!-- Streak Display -->
          <% if current_user.current_streak > 0 %>
            <div class="p-3 mb-4 streak">
              <div class="d-flex align-items-center justify-content-start gap-3">
                <span style="font-size: 2rem;">ðŸ”¥</span>
                <div>
                  <h4 class="mb-0" style="font-size: 1.5rem; font-weight: bold;"><%= current_user.current_streak %> Week Streak!</h4>
                  <p class="mb-0 small">You've been gooiing since <%= @start_date %>.</p>
                  <p class="mb-0 small">You've skipped <%= 100 - current_user.consistency_rate %>% of that time.</p>
                </div>
              </div>
            </div>
          <% end %>
          <h2 class="text-center">Recent Collections</h2>
          <% if @recent_collections.any? %>
            <%= render "past_collections", collections: @recent_collections %>
            <%= link_to "View All Collections", collections_history_path, class: "d-block text-center mt-3" %>
          <% else %>
            <p class="text-center">You haven't had any collections yet</p>
          <% end %>
        </div>
      <% end %>

    </div>
  </div>
